; ==========================================
; Supervisord Config for Antigravity Desktop
; ==========================================

[supervisord]
; Run in foreground so Docker container stays alive
nodaemon=true
; Run as root to allow spawning processes as specific users
user=root
; Log supervisor errors to stdout
logfile=/dev/stdout
logfile_maxbytes=0

; ------------------------------------------
; 1. DBus (System Message Bus)
; Critical dependency for XFCE4. Must start first.
; ------------------------------------------
[program:dbus]
command=/usr/bin/dbus-daemon --system --nofork
priority=1
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ------------------------------------------
; 2. TigerVNC Server (The Desktop Session)
; Runs as user 'antigravity'.
; -fg: Keeps process in foreground for supervisor to track.
; ------------------------------------------
[program:vnc]
command=su - antigravity -c "vncserver :1 -geometry 1920x1080 -depth 24 -fg"
priority=2
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ------------------------------------------
; 3. NoVNC (HTML5 Web Viewer)
; Bridges WebSockets to the VNC TCP port.
; ------------------------------------------
[program:novnc]
command=/usr/bin/websockify --web=/usr/share/novnc/ 6901 localhost:5901
priority=3
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ------------------------------------------
; 4. XRDP (RDP Frontend)
; Listens on 3389.
; ------------------------------------------
[program:xrdp]
command=/usr/sbin/xrdp --nodaemon
priority=4
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ------------------------------------------
; 5. XRDP Session Manager
; Manages RDP sessions connecting to Xorg/VNC.
; ------------------------------------------
[program:xrdp-sesman]
command=/usr/sbin/xrdp-sesman --nodaemon
priority=5
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0